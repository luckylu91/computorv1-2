def find_all_matching_operands(toks):
    dict_par = dict()
    dict_brack = dict()
    stack_par = []
    stack_brack = []
    for i, tok in enumerate(toks):
        if tok == '(':
            stack_par.append(i)
        elif tok == '[':
            stack_brack.append(i)
        elif tok == ')':
            if len(stack_par) == 0:
                raise Exception()
            if len(stack_brack) > 0 and stack_brack[-1] > stack_par[-1]:
                raise Exception()
            ilast_par = stack_par.pop(-1)
            dict_par[ilast_par] = i
        elif tok == ']':
            if len(stack_brack) == 0:
                raise Exception()
            if len(stack_par) > 0 and stack_par[-1] > stack_brack[-1]:
                raise Exception()
            ilast_brack = stack_brack.pop(-1)
            dict_brack[ilast_brack] = i
    return dict_par, dict_brack

def find_matching_operand(toks, operand):
    if toks[0] != operand[0]:
        raise Exception()
    other_operand = '[]' if operand == '()' else '()'
    stack_operand = []
    stack_other_operand = []
    for i, tok in enumerate(toks):
        if tok == operand[0]:
            stack_operand.append(i)
        elif tok == other_operand[0]:
            stack_other_operand.append(i)
        elif tok == operand[1]:
            if len(stack_operand) == 0:
                raise Exception()
            if len(stack_other_operand) > 0 and stack_other_operand[-1] > stack_operand[-1]:
                raise Exception()
            stack_operand.pop(-1)
            return i
        elif tok == other_operand[1]:
            if len(stack_other_operand) == 0:
                raise Exception()
            if len(stack_operand) > 0 and stack_operand[-1] > stack_other_operand[-1]:
                raise Exception()
            stack_other_operand.pop(-1)
    raise Exception()
